<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cc.oxshan.shop.mapper.ShopMapper">

    <resultMap id="BaseResultMap" type="cc.oxshan.shop.entity.Shop">
        <id column="id" property="id"/>
        <result column="parent_id" property="parentId"/>
        <result column="shop_code" property="shopCode"/>
        <result column="shop_name" property="shopName"/>
        <result column="shop_type" property="shopType"/>
        <result column="province" property="province"/>
        <result column="city" property="city"/>
        <result column="district" property="district"/>
        <result column="address" property="address"/>
        <result column="longitude" property="longitude"/>
        <result column="latitude" property="latitude"/>
        <result column="contact_name" property="contactName"/>
        <result column="contact_phone" property="contactPhone"/>
        <result column="business_hours" property="businessHours"/>
        <result column="logo" property="logo"/>
        <result column="images" property="images"/>
        <result column="description" property="description"/>
        <result column="status" property="status"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="sort" property="sort"/>
        <result column="created_by" property="createdBy"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <insert id="insert" parameterType="cc.oxshan.shop.entity.Shop" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO shop (
            parent_id, shop_code, shop_name, shop_type,
            province, city, district, address, longitude, latitude,
            contact_name, contact_phone, business_hours, logo, images,
            description, status, sort, created_by
        ) VALUES (
            #{parentId}, #{shopCode}, #{shopName}, #{shopType},
            #{province}, #{city}, #{district}, #{address}, #{longitude}, #{latitude},
            #{contactName}, #{contactPhone}, #{businessHours}, #{logo}, #{images},
            #{description}, #{status}, #{sort}, #{createdBy}
        )
    </insert>

    <update id="updateById" parameterType="cc.oxshan.shop.entity.Shop">
        UPDATE shop
        <set>
            <if test="shopName != null">shop_name = #{shopName},</if>
            <if test="province != null">province = #{province},</if>
            <if test="city != null">city = #{city},</if>
            <if test="district != null">district = #{district},</if>
            <if test="address != null">address = #{address},</if>
            <if test="contactName != null">contact_name = #{contactName},</if>
            <if test="contactPhone != null">contact_phone = #{contactPhone},</if>
            <if test="businessHours != null">business_hours = #{businessHours},</if>
            <if test="description != null">description = #{description},</if>
            <if test="status != null">status = #{status},</if>
        </set>
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <update id="deleteById">
        UPDATE shop SET is_deleted = 1 WHERE id = #{id}
    </update>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT * FROM shop WHERE id = #{id} AND is_deleted = 0
    </select>

    <select id="selectByCode" resultMap="BaseResultMap">
        SELECT * FROM shop WHERE shop_code = #{shopCode} AND is_deleted = 0
    </select>

    <select id="selectList" resultMap="BaseResultMap">
        SELECT * FROM shop
        WHERE is_deleted = 0
        <if test="parentId != null">
            AND parent_id = #{parentId}
        </if>
        <if test="shopName != null and shopName != ''">
            AND shop_name LIKE CONCAT('%', #{shopName}, '%')
        </if>
        <if test="shopType != null">
            AND shop_type = #{shopType}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY sort ASC, created_at DESC
    </select>

    <select id="selectByParentId" resultMap="BaseResultMap">
        SELECT * FROM shop WHERE parent_id = #{parentId} AND is_deleted = 0
    </select>

    <select id="countBranches" resultType="int">
        SELECT COUNT(*) FROM shop WHERE parent_id = #{parentId} AND is_deleted = 0
    </select>

</mapper>
